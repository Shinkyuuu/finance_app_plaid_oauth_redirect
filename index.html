<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Plaid OAuth Redirect</title>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
</head>
<body>
  <h2 id="status">Loading Plaid Link...</h2>
  <script>
    (async () => {
      const params = new URLSearchParams(window.location.search);
      let linkToken = params.get("link_token");

      if (linkToken) {
        localStorage.setItem("plaid_link_token", linkToken);
        console.log("Stored link_token for reuse.");
      } else {
        linkToken = localStorage.getItem("plaid_link_token");
        console.log("Retrieved stored link_token:", linkToken);
      }

      if (!linkToken) {
        document.getElementById("status").innerText =
          "Error: No link_token found. Please start linking again.";
        return;
      }

      const handler = Plaid.create({
        token: linkToken,
        receivedRedirectUri: window.location.href,
        onSuccess: async (public_token, metadata) => {
          document.getElementById("status").innerText = "Exchanging token...";
          await fetch("https://your-api.execute-api.us-east-1.amazonaws.com/Stage2/exchange-public-token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ public_token }),
          });
          document.getElementById("status").innerText =
            "âœ… Bank linked successfully. You can close this window.";
          localStorage.removeItem("plaid_link_token");
        },
        onExit: (err, metadata) => {
          console.error("Plaid exit:", err, metadata);
          document.getElementById("status").innerText = "Linking cancelled.";
        },
      });

      handler.open();
    })();
  </script>
</body>
</html>
