<!DOCTYPE html>
<html>
<head>
  <title>Plaid OAuth Complete</title>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
</head>
<body>
<h2>Processing your bank connection...</h2>

<script>
(async () => {
  const params = new URLSearchParams(window.location.search);
  const linkToken = params.get('token');               // <-- read from URL
  const receivedRedirectUri = window.location.href;    // contains oauth_state_id

  if (!linkToken) {
      document.body.innerHTML = "<h2>Error: No link token found in URL.</h2>";
      return;
  }

  const handler = Plaid.create({
    token: linkToken,
    receivedRedirectUri,
    onSuccess: async (public_token) => {
      document.body.innerHTML = "<h2>Exchanging token...</h2>";
      try {
        await fetch('https://umsdo186p8.execute-api.us-east-1.amazonaws.com/Stage2/exchange-public-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ public_token })
        });
        document.body.innerHTML = "<h2>OAuth Complete! You can return to the app.</h2>";
      } catch (err) {
        document.body.innerHTML = `<h2>Error exchanging token: ${err.message}</h2>`;
      }
    },
    onExit: (err) => {
      if (err) {
        document.body.innerHTML = `<h2>Link exited with error: ${err.display_message || err.error_message}</h2>`;
      } else {
        document.body.innerHTML = "<h2>Link exited without completing OAuth.</h2>";
      }
    }
  });

  handler.open();
})();
</script>
</body>
</html>
